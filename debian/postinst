#!/bin/bash

set -e

adduser --system --home /var/backups/automydumper --group automydumper

if [ -e /etc/default/automydumper ] ; then
	grep -v ^# /etc/default/automydumper >> /etc/automydumper.cfg
	rm -f /etc/default/automydumper
fi

if [ -e /etc/automydumper.cfg ] ; then
	. /etc/automydumper.cfg
fi

if [ -z "${backupdir}" ] ; then
	backupdir=/var/backups/automydumper
fi

mkdir -p "${backupdir}"
chmod 0600 "${backupdir}"
chown automydumper:root "${backupdir}" -R

chown automydumper:root /etc/automydumper.cfg
chmod 0640 /etc/automydumper.cfg

if [ -f /etc/cron.d/automydumper ]; then
    minute="$(cat /etc/cron.d/automydumper | gawk '/([0-9]+)\s+([0-9]+).*\/usr\/sbin\/automydumper/ { print $1 }')"
    hour="$(cat /etc/cron.d/automydumper | gawk '/([0-9]+)\s+([0-9]+).*\/usr\/sbin\/automydumper/ { print $2 }')"
else
    minute="$((RANDOM%59))"
    hour="$((RANDOM%4))"
fi

cat <<EOF > /etc/cron.d/automydumper
#
# cron-job for automydumper
#

${minute} ${hour} * * * automydumper /usr/sbin/automydumper &> /dev/null
EOF

#DEBHELPER#
